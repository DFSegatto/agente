<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SiteHunter Free</title>

  <!-- Biblioteca Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<h2>Buscar empresas sem site</h2>

<input id="cidade" placeholder="Cidade">
<input id="estado" placeholder="Estado">
<button onclick="buscarEmpresas()">Buscar</button>

<h3>Resultados</h3>
<ul id="lista"></ul>

<script>
const SUPABASE_URL = "https://evefnjpjxqxydknyjutt.supabase.co"
const SUPABASE_KEY = "sb_publishable_Ou4ChPNEA1mYc6ESE2UsEQ_EZZ4nyE7"

// nome diferente para não conflitar
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

async function buscarEmpresas() {

  const cidade = document.getElementById("cidade").value
  const estado = document.getElementById("estado").value

  const query = `
  [out:json];
  area["name"="${cidade}"]->.searchArea;
  (
    node["shop"](area.searchArea);
    node["amenity"](area.searchArea);
  );
  out tags;
  `;

  const res = await fetch("https://overpass-api.de/api/interpreter", {
    method: "POST",
    body: query
  });

  const data = await res.json();

  const semSite = data.elements.filter(e => !e.tags.website);

  const lista = document.getElementById("lista");
  lista.innerHTML = "";

  for (const e of semSite) {

    const lead = {
      nome: e.tags.name || "",
      cidade: cidade,
      estado: estado,
      telefone: e.tags.phone || "",
      endereco: e.tags["addr:street"] || "",
      categoria: e.tags.shop || e.tags.amenity || "",
      website: "",
      status: "sem_site"
    }

    await sb.from("leads").insert(lead)

    lista.innerHTML += `<li>${lead.nome} — ${lead.telefone}</li>`
  }
}
</script>

</body>
</html>
