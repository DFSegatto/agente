<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Modo Ca√ßa-Clientes Extremo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { font-family: Arial; margin: 20px; }
#mapa { height: 420px; margin-top: 20px; }
button { margin: 5px; padding: 8px 12px; }
input { padding: 8px; }
</style>
</head>
<body>

<h2>üöÄ MODO CA√áA-CLIENTES EXTREMO</h2>

<input id="cidade" placeholder="Digite a cidade">
<button onclick="buscar()">Ca√ßar Clientes</button>
<button onclick="exportarCSV()">Exportar Leads</button>

<pre id="lista"></pre>
<div id="mapa"></div>

<script>

let empresasGlobal = [];

let mapa = L.map('mapa').setView([-27, -51], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);

async function buscar() {

  const cidadeValor = document.getElementById("cidade").value.trim();
  const lista = document.getElementById("lista");

  if (!cidadeValor){
    alert("Digite a cidade");
    return;
  }

  lista.textContent = "Localizando cidade...";

  // Geocodifica√ß√£o da cidade
  const geoResp = await fetch(
    `https://nominatim.openstreetmap.org/search?city=${cidadeValor}&country=Brazil&format=json`
  );

  const geoData = await geoResp.json();

  if (geoData.length === 0){
    lista.textContent = "Cidade n√£o encontrada.";
    return;
  }

  const { lat, lon, boundingbox } = geoData[0];

  const south = boundingbox[0];
  const north = boundingbox[1];
  const west = boundingbox[2];
  const east = boundingbox[3];

  lista.textContent = "Ca√ßando clientes quentes...";

  const query = `
  [out:json][timeout:25];
  (
    node["shop"](${south},${west},${north},${east});
    node["amenity"~"restaurant|cafe|fast_food|pharmacy|clinic|bar|pub"](${south},${west},${north},${east});
    node["office"](${south},${west},${north},${east});
    node["tourism"="hotel"](${south},${west},${north},${east});
  );
  out tags center 80;
  `;

  try {

    const response = await fetch(
      "https://overpass-api.de/api/interpreter",
      { method:"POST", body:query }
    );

    const data = await response.json();

    // üî• FILTRO EXTREMO
    const empresas = data.elements
      .filter(e => {
        if (!e.tags || !e.tags.name) return false;

        const t = e.tags;

        const semSite = !t.website && !t["contact:website"];
        const temTelefone = t.phone || t["contact:phone"];
        const temRede = t["contact:instagram"] || t["contact:facebook"];

        return semSite && temTelefone && temRede;
      })
      .slice(0,20);

    mapa.setView([lat, lon], 13);

    mapa.eachLayer(l => {
      if (l instanceof L.Marker) mapa.removeLayer(l);
    });

    if (empresas.length === 0){
      lista.textContent = "Nenhum cliente encontrado.";
      return;
    }

    empresasGlobal = empresas;

    lista.textContent = empresas.map((e,i)=>{

      const t = e.tags;

      const tipo = t.shop || t.amenity || t.office || t.tourism || "empresa";
      const telefone = t.phone || t["contact:phone"];
      const redes = t["contact:instagram"] || t["contact:facebook"];
      const endereco =
        (t["addr:street"] || "") + " " + (t["addr:housenumber"] || "");

      const latE = e.lat || e.center?.lat;
      const lonE = e.lon || e.center?.lon;

      if (latE && lonE){
        L.marker([latE, lonE])
          .addTo(mapa)
          .bindPopup(`
            <b>${t.name}</b><br>
            ${tipo}<br>
            üìû ${telefone}<br>
            üìç ${endereco}<br>
            ‚ùå SEM SITE
          `);
      }

      return `
üî• CLIENTE QUENTE ${i+1}
${t.name}
Tipo: ${tipo}
Telefone: ${telefone}
Endere√ßo: ${endereco}
Redes: ${redes}
‚ùå N√ÉO POSSUI SITE
`;

    }).join("\n=====================");

  } catch (erro){
    lista.textContent = "Erro na busca.";
    console.error(erro);
  }
}

function exportarCSV(){

  if (empresasGlobal.length === 0){
    alert("Nenhum lead para exportar.");
    return;
  }

  let csv = "Nome,Tipo,Telefone,Endereco,Redes\n";

  empresasGlobal.forEach(e=>{
    const t = e.tags;

    const tipo = t.shop || t.amenity || t.office || t.tourism || "empresa";
    const telefone = t.phone || t["contact:phone"] || "";
    const redes = t["contact:instagram"] || t["contact:facebook"] || "";
    const endereco =
      (t["addr:street"] || "") + " " + (t["addr:housenumber"] || "");

    csv += `"${t.name}","${tipo}","${telefone}","${endereco}","${redes}"\n`;
  });

  const blob = new Blob([csv], { type:"text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "leads_extremos.csv";
  link.click();
}

</script>

</body>
</html>
