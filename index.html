<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>AGENTE CAÇA CLIENTES EXTREMO</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>

<body>

Estado: <input id="estado" placeholder="SC ou Santa Catarina"><br><br>
Cidade: <input id="cidade" placeholder="Ex: Joaçaba"><br><br>

<button onclick="buscar()">CAÇAR EMPRESAS</button>

<pre id="resultado"></pre>

<script>
const supabaseUrl = "https://SEU_PROJETO.supabase.co";
const supabaseKey = "SUA_CHAVE_PUBLICA";
const db = supabase.createClient(supabaseUrl, supabaseKey);

async function buscar() {

const estado = document.getElementById("estado").value.trim();
const cidade = document.getElementById("cidade").value.trim();

document.getElementById("resultado").textContent = "CAÇANDO EMPRESAS...";

const areaQuery = `
[out:json][timeout:25];
area["name"="${cidade}"]["is_in:state"="${estado}"]->.searchArea;
out ids;
`;

const areaRes = await fetch("https://overpass-api.de/api/interpreter", {
method:"POST",
body: areaQuery
});

const areaData = await areaRes.json();
const areaId = areaData.elements[0].id + 3600000000;

let empresas = [];

const filtros = `
["shop"]
["amenity"~"restaurant|cafe|bar|clinic|pharmacy|dentist|school|hospital|fuel"]
`;

const exclusoes = `
["amenity"!~"bank|atm|police|townhall|courthouse|school|university"]
["office"!~"government"]
`;

const quadrantes = [
"",
"(._;>;);",
"(._;<<;);",
"(._;>;<<;);"
];

for (let i=0;i<quadrantes.length;i++){

try{

const query = `
[out:json][timeout:25];
area(${areaId})->.searchArea;
(
node${filtros}${exclusoes}(area.searchArea);
way${filtros}${exclusoes}(area.searchArea);
relation${filtros}${exclusoes}(area.searchArea);
);
out tags center ${quadrantes[i]};
`;

const res = await fetch("https://overpass-api.de/api/interpreter", {
method:"POST",
body: query
});

const data = await res.json();

empresas.push(...data.elements);

await new Promise(r => setTimeout(r, 2000));

}catch(e){
console.log("Falha em um quadrante, continuando...");
}

}

const filtradas = empresas.filter(e =>
e.tags &&
e.tags.name &&
!e.tags.website &&
!e.tags["contact:website"] &&
!e.tags.brand &&
!e.tags.operator &&
(
e.tags.phone ||
e.tags["contact:phone"] ||
e.tags.email ||
e.tags["contact:email"]
)
).slice(0,20);

let texto = "";

for (const e of filtradas){

const nome = e.tags.name || "Sem nome";
const telefone = e.tags.phone || e.tags["contact:phone"] || "Sem telefone";
const email = e.tags.email || e.tags["contact:email"] || "Sem email";
const tipo = e.tags.shop || e.tags.amenity || "Empresa";

texto += `${nome} (${tipo})
Telefone: ${telefone}
Email: ${email}

`;

await db.from("empresas").insert({
nome,
telefone,
email,
tipo,
cidade,
estado
});

}

document.getElementById("resultado").textContent =
texto || "Nenhuma empresa encontrada";

}
</script>

</body>
</html>
