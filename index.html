<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SiteHunter Free</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<h2>Buscar atÃ© 20 empresas sem site</h2>

<input id="cidade" placeholder="Cidade">
<input id="estado" placeholder="Estado">
<button onclick="buscarEmpresas()">Buscar</button>

<p id="status"></p>

<h3>Resultados</h3>
<ul id="lista"></ul>

<script>
const SUPABASE_URL = "https://evefnjpjxqxydknyjutt.supabase.co"
const SUPABASE_KEY = "sb_publishable_Ou4ChPNEA1mYc6ESE2UsEQ_EZZ4nyE7"

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

async function buscarEmpresas() {

  const cidade = document.getElementById("cidade").value
  const estado = document.getElementById("estado").value

  document.getElementById("status").innerText = "Buscando empresas..."

  const query = `
  [out:json][timeout:25];
  area["name"="${cidade}"]->.searchArea;
  (
    node["shop"](area.searchArea);
    node["amenity"](area.searchArea);
  );
  out tags 20;
  `;

  try {

    const res = await fetch("https://overpass.kumi.systems/api/interpreter", {
      method: "POST",
      body: query
    });

    if (!res.ok) {
      document.getElementById("status").innerText =
        "Servidor ocupado. Aguarde 1 minuto e tente novamente.";
      return;
    }

    const data = await res.json();

    const semSite = data.elements.filter(e => !e.tags.website);

    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    for (const e of semSite) {

      const lead = {
        nome: e.tags.name || "Sem nome",
        cidade: cidade,
        estado: estado,
        telefone: e.tags.phone || "",
        endereco: e.tags["addr:street"] || "",
        categoria: e.tags.shop || e.tags.amenity || "",
        website: "",
        status: "sem_site"
      }

      // salva no Supabase
      await sb.from("leads").insert(lead)

      lista.innerHTML += `
        <li>
          <b>${lead.nome}</b><br>
          ğŸ“ ${lead.endereco}<br>
          â˜ ${lead.telefone}<br>
          ğŸ· ${lead.categoria}
        </li>
      `
    }

    document.getElementById("status").innerText =
      `Encontradas ${semSite.length} empresas sem site`

  } catch (err) {

    document.getElementById("status").innerText =
      "Erro ao buscar. Tente novamente."

    console.error(err)
  }
}
</script>

</body>
</html>
