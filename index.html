<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Buscador PRO de Empresas</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { font-family: Arial; margin: 20px; }
#mapa { height: 400px; margin-top: 20px; }
button { margin: 5px; }
</style>
</head>
<body>

<h2>ðŸ”Ž Buscador PRO de Empresas Privadas</h2>

<input id="cidade" placeholder="Cidade">
<input id="estado" placeholder="Estado (SC ou Santa Catarina)">
<button onclick="buscar()">Buscar</button>
<button onclick="exportarCSV()">Exportar Excel</button>

<pre id="lista"></pre>
<div id="mapa"></div>

<script>
let empresasGlobal = [];
let mapa = L.map('mapa').setView([-27, -51], 7);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);

async function buscar() {

  const cidadeValor = document.getElementById("cidade").value.trim();
  const lista = document.getElementById("lista");

  if (!cidadeValor){
    alert("Digite a cidade");
    return;
  }

  lista.textContent = "Localizando cidade...";

  // 1ï¸âƒ£ Geocodificar cidade
  const geoResp = await fetch(
    `https://nominatim.openstreetmap.org/search?city=${cidadeValor}&country=Brazil&format=json`
  );

  const geoData = await geoResp.json();

  if (geoData.length === 0){
    lista.textContent = "Cidade nÃ£o encontrada.";
    return;
  }

  const { lat, lon, boundingbox } = geoData[0];

  const south = boundingbox[0];
  const north = boundingbox[1];
  const west = boundingbox[2];
  const east = boundingbox[3];

  lista.textContent = "Buscando empresas privadas...";

  // 2ï¸âƒ£ Consulta leve por bounding box
  const query = `
  [out:json][timeout:25];
  (
    node["shop"](${south},${west},${north},${east});
    node["amenity"~"restaurant|cafe|fast_food|pharmacy|clinic|bar|pub"](${south},${west},${north},${east});
    node["office"](${south},${west},${north},${east});
    node["tourism"="hotel"](${south},${west},${north},${east});
  );
  out tags center 20;
  `;

  try {

    const response = await fetch(
      "https://overpass-api.de/api/interpreter",
      { method:"POST", body:query }
    );

    const data = await response.json();

    const empresas = data.elements
      .filter(e => e.tags && e.tags.name)
      .slice(0,20);

    mapa.setView([lat, lon], 13);

    mapa.eachLayer(l => {
      if (l instanceof L.Marker) mapa.removeLayer(l);
    });

    if (empresas.length === 0){
      lista.textContent = "Nenhuma empresa encontrada.";
      return;
    }

    empresasGlobal = empresas;

    lista.textContent = empresas.map((e,i)=>{

      const tipo =
        e.tags.shop ||
        e.tags.amenity ||
        e.tags.office ||
        e.tags.tourism ||
        "empresa";

      const latE = e.lat || e.center?.lat;
      const lonE = e.lon || e.center?.lon;

      if (latE && lonE){
        L.marker([latE, lonE])
          .addTo(mapa)
          .bindPopup(`<b>${e.tags.name}</b><br>${tipo}`);
      }

      return `${i+1}. ${e.tags.name} â€” ${tipo}`;

    }).join("\n");

  } catch (erro){
    lista.textContent = "Erro na busca.";
    console.error(erro);
  }
}

function exportarCSV() {

    if (empresasGlobal.length === 0) {
        alert("Busque empresas primeiro.");
        return;
    }

    let csv = "Nome,Tipo\n";

    empresasGlobal.forEach(e => {
        const tipo = e.tags.shop || e.tags.amenity || e.tags.office || e.tags.tourism || "empresa";
        csv += `"${e.tags.name}","${tipo}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "empresas.csv";
    link.click();
}
</script>

</body>
</html>
