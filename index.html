<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Agente Ca√ßa-Clientes PRO</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { font-family: Arial; margin: 20px; }
#mapa { height: 420px; margin-top: 20px; }
fieldset { margin-top: 10px; }
button { margin: 5px; padding: 8px 12px; }
</style>
</head>
<body>

<h2>üöÄ Agente Ca√ßa-Clientes PRO</h2>

Cidade:
<input id="cidade" placeholder="Ex: Joa√ßaba">

Quantidade:
<input id="limite" type="number" value="20" min="1" max="100">

<fieldset>
<legend>Tipos de empresa</legend>
<label><input type="checkbox" id="shop" checked> Lojas</label>
<label><input type="checkbox" id="food" checked> Restaurantes</label>
<label><input type="checkbox" id="office" checked> Escrit√≥rios</label>
<label><input type="checkbox" id="hotel" checked> Hot√©is</label>
</fieldset>

<fieldset>
<legend>Filtros de leads</legend>
<label><input type="checkbox" id="semSite" checked> Apenas sem site</label>
<label><input type="checkbox" id="comTelefone" checked> Exigir telefone</label>
<label><input type="checkbox" id="comRede"> Exigir redes sociais</label>
</fieldset>

<button onclick="buscar()">Buscar</button>
<button onclick="exportarCSV()">Exportar Leads</button>

<pre id="lista"></pre>
<div id="mapa"></div>

<script>

let empresasGlobal = [];

let mapa = L.map('mapa').setView([-27, -51], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);

async function buscar() {

  const cidade = document.getElementById("cidade").value.trim();
  const limite = document.getElementById("limite").value;
  const lista = document.getElementById("lista");

  if (!cidade){
    alert("Digite a cidade");
    return;
  }

  lista.textContent = "Localizando cidade...";

  // Geocodifica√ß√£o
  const geoResp = await fetch(
    `https://nominatim.openstreetmap.org/search?city=${cidade}&country=Brazil&format=json`
  );
  const geoData = await geoResp.json();

  if (geoData.length === 0){
    lista.textContent = "Cidade n√£o encontrada.";
    return;
  }

  const { lat, lon, boundingbox } = geoData[0];
  const south = boundingbox[0];
  const north = boundingbox[1];
  const west = boundingbox[2];
  const east = boundingbox[3];

  lista.textContent = "Buscando empresas...";

  // Montar consulta conforme filtros
  let partes = [];

  if (shop.checked)
    partes.push(`node["shop"](${south},${west},${north},${east});`);

  if (food.checked)
    partes.push(`node["amenity"~"restaurant|cafe|fast_food|bar|pub"](${south},${west},${north},${east});`);

  if (office.checked)
    partes.push(`node["office"](${south},${west},${north},${east});`);

  if (hotel.checked)
    partes.push(`node["tourism"="hotel"](${south},${west},${north},${east});`);

  const query = `
  [out:json][timeout:25];
  (
    ${partes.join("\n")}
  );
  out tags center ${limite};
  `;

  try {

    const response = await fetch(
      "https://overpass-api.de/api/interpreter",
      { method:"POST", body:query }
    );

    const data = await response.json();

    // Aplicar filtros
    const empresas = data.elements.filter(e => {

      if (!e.tags || !e.tags.name) return false;
      const t = e.tags;

      if (semSite.checked && (t.website || t["contact:website"]))
        return false;

      if (comTelefone.checked && !(t.phone || t["contact:phone"]))
        return false;

      if (comRede.checked &&
         !(t["contact:instagram"] || t["contact:facebook"]))
        return false;

      return true;
    });

    mapa.setView([lat, lon], 13);

    mapa.eachLayer(l => {
      if (l instanceof L.Marker) mapa.removeLayer(l);
    });

    if (empresas.length === 0){
      lista.textContent = "Nenhum resultado encontrado.";
      return;
    }

    empresasGlobal = empresas;

    lista.textContent = empresas.map((e,i)=>{

      const t = e.tags;
      const tipo = t.shop || t.amenity || t.office || t.tourism || "empresa";
      const telefone = t.phone || t["contact:phone"] || "";
      const redes = t["contact:instagram"] || t["contact:facebook"] || "";
      const endereco =
        (t["addr:street"] || "") + " " + (t["addr:housenumber"] || "");

      const latE = e.lat || e.center?.lat;
      const lonE = e.lon || e.center?.lon;

      if (latE && lonE){
        L.marker([latE, lonE])
          .addTo(mapa)
          .bindPopup(`<b>${t.name}</b><br>${tipo}<br>${telefone}`);
      }

      return `
${i+1}. ${t.name}
Tipo: ${tipo}
Telefone: ${telefone}
Endere√ßo: ${endereco}
Redes: ${redes}
`;

    }).join("\n====================");

  } catch (erro){
    lista.textContent = "Erro na busca.";
    console.error(erro);
  }
}

function exportarCSV(){

  if (empresasGlobal.length === 0){
    alert("Nenhum lead para exportar.");
    return;
  }

  let csv = "Nome,Tipo,Telefone,Endereco,Redes\n";

  empresasGlobal.forEach(e=>{
    const t = e.tags;

    const tipo = t.shop || t.amenity || t.office || t.tourism || "";
    const telefone = t.phone || t["contact:phone"] || "";
    const redes = t["contact:instagram"] || t["contact:facebook"] || "";
    const endereco =
      (t["addr:street"] || "") + " " + (t["addr:housenumber"] || "");

    csv += `"${t.name}","${tipo}","${telefone}","${endereco}","${redes}"\n`;
  });

  const blob = new Blob([csv], { type:"text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "leads.csv";
  link.click();
}

</script>

</body>
</html>
